{{ $currentPage := . }}

<div class="book-menu-enhanced">
  <!-- Brand Header -->
  {{ partial "docs/brand-unified" (dict "Site" .Site "context" "sidebar") }}

  <!-- Search Box - Using unified search component -->
  <div class="menu-search">
    {{ partial "docs/search-unified" (dict "Site" .Site "context" "sidebar") }}
  </div>

  <!-- Quick Actions Section -->
  <div class="menu-section">
    <div class="menu-section-header">Quick Actions</div>
    <ul class="menu-section-items">
      <li>
        <a href="/docs/delphi/sign-up/" class="menu-item menu-item-cta">
          Get Started
        </a>
      </li>
    </ul>
  </div>

  <!-- Platform Section - Auto-discovered from /docs/delphi/ -->
  {{ $delphiSection := .Site.GetPage "/docs/delphi" }}
  {{ if $delphiSection }}
  <div class="menu-section">
    <div class="menu-section-header">Platform</div>
    <ul class="menu-section-items">
      <li class="menu-item-expandable">
        <input type="checkbox" id="menu-platform" class="toggle" />
        <label for="menu-platform" class="menu-item">
          <span>Platform</span>
        </label>
        <ul class="menu-sub-items">
          <!-- Main Delphi page -->
          {{ $isActive := partial "docs/nav-helpers" (dict "type" "isActive" "currentPage" $currentPage "url" $delphiSection.RelPermalink) }}
          <li><a href="{{ $delphiSection.RelPermalink }}" class="menu-sub-item{{ if $isActive }} active{{ end }}">{{ $delphiSection.Title }}</a></li>
          
          <!-- Auto-discovered sub-pages -->
          {{ range $delphiSection.Pages.ByWeight }}
            {{ if not .Params.bookHidden }}
              {{ $isActive := partial "docs/nav-helpers" (dict "type" "isActive" "currentPage" $currentPage "url" .RelPermalink) }}
              <li><a href="{{ .RelPermalink }}" class="menu-sub-item{{ if $isActive }} active{{ end }}">{{ .Title }}</a></li>
            {{ end }}
          {{ end }}
        </ul>
      </li>
    </ul>
  </div>
  {{ end }}

  <!-- Training Section - Auto-discovered from /docs/training/ -->
  {{ $trainingSection := .Site.GetPage "/docs/training" }}
  {{ if $trainingSection }}
  <div class="menu-section">
    <div class="menu-section-header">Training</div>
    <ul class="menu-section-items">
      <li class="menu-item-expandable">
        <input type="checkbox" id="menu-training" class="toggle" />
        <label for="menu-training" class="menu-item">
          <span>Training</span>
        </label>
        <ul class="menu-sub-items">
          <!-- Main Training page -->
          {{ $isActive := partial "docs/nav-helpers" (dict "type" "isActive" "currentPage" $currentPage "url" $trainingSection.RelPermalink) }}
          <li><a href="{{ $trainingSection.RelPermalink }}" class="menu-sub-item{{ if $isActive }} active{{ end }}">{{ $trainingSection.Title }}</a></li>
          
          <!-- Auto-discovered sub-pages -->
          {{ range $trainingSection.Pages.ByWeight }}
            {{ if not .Params.bookHidden }}
              {{ $isActive := partial "docs/nav-helpers" (dict "type" "isActive" "currentPage" $currentPage "url" .RelPermalink) }}
              <li><a href="{{ .RelPermalink }}" class="menu-sub-item{{ if $isActive }} active{{ end }}">{{ .Title }}</a></li>
            {{ end }}
          {{ end }}
        </ul>
      </li>
    </ul>
  </div>
  {{ end }}

  <!-- Resources Section - Auto-discovered from top-level /docs/ pages -->
  {{ $docsSection := .Site.GetPage "/docs" }}
  {{ if $docsSection }}
  <div class="menu-section">
    <div class="menu-section-header">Resources</div>
    <ul class="menu-section-items">
      <!-- Documentation overview -->
      {{ $isActive := partial "docs/nav-helpers" (dict "type" "isActiveExact" "currentPage" $currentPage "url" "/docs/") }}
      <li>
        <a href="/docs/" class="menu-item{{ if $isActive }} active{{ end }}">
          Documentation
        </a>
      </li>
      
      <!-- Auto-discovered top-level pages (excluding major sections) -->
      {{ range $docsSection.Pages.ByWeight }}
        {{ if and (not .Params.bookHidden) (not (in (slice "delphi" "training") .File.Dir)) }}
          {{ $isActive := false }}
          {{ if eq .RelPermalink "/docs/" }}
            {{ $isActive = partial "docs/nav-helpers" (dict "type" "isActiveExact" "currentPage" $currentPage "url" .RelPermalink) }}
          {{ else }}
            {{ $isActive = partial "docs/nav-helpers" (dict "type" "isActive" "currentPage" $currentPage "url" .RelPermalink) }}
          {{ end }}
          <li>
            <a href="{{ .RelPermalink }}" class="menu-item{{ if $isActive }} active{{ end }}">
              {{ .Title }}
            </a>
          </li>
        {{ end }}
      {{ end }}
      
      <!-- Blog link -->
      <li>
        {{ $isActive := partial "docs/nav-helpers" (dict "type" "isActive" "currentPage" $currentPage "url" "/posts/") }}
        <a href="/posts/" class="menu-item{{ if $isActive }} active{{ end }}">
          Blog
        </a>
      </li>
    </ul>
  </div>
  {{ end }}
</div>